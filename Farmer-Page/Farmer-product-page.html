<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/Farmer-Style/Farmer-product-page.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <title>Manage Products - FarmPick</title>
</head>

<body>
  <!-- Mobile Menu Toggle -->
  <button class="menu-toggle" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></button>

  <aside class="sidebar" id="sidebar">
    <div class="logo">
      <div class="logo-icon"><i class="fa-solid fa-leaf"></i></div>
      <div class="logo-text">FarmConnect</div>
    </div>

    <ul class="sidebar-menu">
      <li class="menu-item">
        <a href="/Farmer-Page/Farmer-dashboard.html" class="menu-link">
          <span class="menu-icon"><i class="fa-solid fa-chart-pie"></i></span>
          <span>Dashboard</span>
        </a>
      </li>
      <li class="menu-item">
        <a href="/Farmer-Page/Farmer-product-page.html" class="menu-link active">
          <span class="menu-icon"><i class="fa-solid fa-box-open"></i></span>
          <span>Products</span>
        </a>
      </li>
      <li class="menu-item">
        <a href="/Farmer-Page/Farmer-order-page.html" class="menu-link">
          <span class="menu-icon"><i class="fa-solid fa-cart-shopping"></i></span>
          <span>Orders</span>
        </a>
      </li>
      <li class="menu-item">
        <a href="/Farmer-Page/Farmer-earning-page.html" class="menu-link">
          <span class="menu-icon"><i class="fa-solid fa-wallet"></i></span>
          <span>Earnings</span>
        </a>
      </li>
      <li class="menu-item">
        <a href="#settings" class="menu-link">
          <span class="menu-icon"><i class="fa-solid fa-gear"></i></span>
          <span>Settings</span>
        </a>
      </li>
      <li class="menu-item">
        <a href="#" class="menu-link" onclick="logout()">
          <span class="menu-icon"><i class="fa-solid fa-right-from-bracket"></i></span>
          <span>Logout</span>
        </a>
      </li>
    </ul>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Top Header -->
    <div class="top-header">
      <span class="breadcrumb-icon"><i class="fa-solid fa-bars-staggered"></i></span>
      <span class="breadcrumb-text">Seller Dashboard</span>
    </div>

    <!-- Page Header -->
    <div class="page-header">
      <div class="header-top">
        <div class="header-content">
          <h1>Manage Products</h1>
          <p>Add, edit, or remove your farm products</p>
        </div>
        <button class="add-product-btn" onclick="location.href='/Farmer-Page/Add-product.html'">
          <span><i class="fa-solid fa-plus"></i></span>
          <span>Add Product</span>
        </button>
      </div>

      <div class="search-container">
        <span class="search-icon"><i class="fa-solid fa-magnifying-glass"></i></span>
        <input type="text" class="search-input" placeholder="Search products..." id="search-products" />
      </div>
    </div>

    <!-- Products Grid -->
    <section class="products-section">
      <div class="products-grid" id="p-grid">
        <!-- Products will be loaded here dynamically -->
      </div>
    </section>
  </main>

  <script type="module">
    import apiRequest from "/js/api.js";
    import { getCurrentUser, logout } from "/js/auth.js";
    import { showToast } from "/js/notifications.js";
    window.logout = logout;

    async function loadProducts() {
      const user = getCurrentUser();
      if (!user || !user.farmer_id) {
        // If not logged in as farmer, redirect or show empty
        window.location.href = '/pages/login.html';
        return;
      }

      try {
        const products = await apiRequest(`/products/farmer/${user.farmer_id}`, "GET");
        const grid = document.getElementById("p-grid");

        if (products.length === 0) {
          grid.innerHTML = "<p>No products added yet.</p>";
          return;
        }

        grid.innerHTML = products.map(p => `
                    <div class="product-card">
                        <img
                          src="${p.image_url || 'https://via.placeholder.com/300'}"
                          alt="${p.name}"
                          class="product-image"
                          onerror="this.src='https://via.placeholder.com/300'"
                        />
                        <div class="product-content">
                          <div class="product-header">
                            <div>
                              <h3 class="product-title">${p.name}</h3>
                              <p class="product-category">Category ID: ${p.category_id}</p>
                            </div>
                            <span class="stock-badge ${p.quantity > 0 ? 'badge-in-stock' : 'badge-out-stock'}">
                                ${p.quantity > 0 ? 'In Stock' : 'Out of Stock'}
                            </span>
                          </div>

                          <div class="product-details">
                            <div class="detail-row">
                              <span class="detail-label">Price:</span>
                              <span class="detail-value">â‚¹${p.price}</span>
                            </div>
                            <div class="detail-row">
                              <span class="detail-label">Quantity:</span>
                              <span class="detail-value">${p.quantity}</span>
                            </div>
                          </div>

                          <span class="certified-badge">Organic Certified</span>

                          <div class="product-actions">
                            <button class="action-btn" onclick="window.location.href='/Farmer-Page/Add-product.html?id=${p.id}'">
                              <span><i class="fa-solid fa-pen"></i></span>
                              <span>Edit</span>
                            </button>
                            <button class="delete-btn" onclick="deleteProduct(${p.id})">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                          </div>
                        </div>
                    </div>
                `).join('');

        // Implement search
        const searchInput = document.getElementById('search-products');
        searchInput.addEventListener('input', (e) => {
          const term = e.target.value.toLowerCase();
          const cards = document.querySelectorAll('.product-card');
          cards.forEach(card => {
            const title = card.querySelector('.product-title').innerText.toLowerCase();
            if (title.includes(term)) {
              card.style.display = 'block';
            } else {
              card.style.display = 'none';
            }
          });
        });

      } catch (err) {
        console.error("Error loading products:", err);
      }
    }

    window.deleteProduct = async (id) => {
      if (confirm('Are you sure you want to delete this product?')) {
        try {
          await apiRequest(`/products/${id}`, 'DELETE');
          loadProducts(); // Refresh
        } catch (err) {
          showToast('Failed to delete product', 'error');
        }
      }
    };

    window.toggleSidebar = () => {
      document.getElementById("sidebar").classList.toggle("active");
    };

    loadProducts();
  </script>
</body>

</html>