<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/Farmer-Style/Farmer-dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <title>Farmer Dashboard - FarmPick</title>
</head>

<body>
    <!-- Mobile Menu Toggle -->
    <button class="menu-toggle" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></button>

    <aside class="sidebar" id="sidebar">
        <div class="logo">
            <div class="logo-icon"><i class="fa-solid fa-leaf"></i></div>
            <div class="logo-text">FarmConnect</div>
        </div>

        <ul class="sidebar-menu">
            <li class="menu-item">
                <a href="/Farmer-Page/Farmer-dashboard.html" class="menu-link active">
                    <span class="menu-icon"><i class="fa-solid fa-chart-pie"></i></span>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="menu-item">
                <a href="/Farmer-Page/Farmer-product-page.html" class="menu-link">
                    <span class="menu-icon"><i class="fa-solid fa-box-open"></i></span>
                    <span>Products</span>
                </a>
            </li>
            <li class="menu-item">
                <a href="/Farmer-Page/Farmer-order-page.html" class="menu-link">
                    <span class="menu-icon"><i class="fa-solid fa-cart-shopping"></i></span>
                    <span>Orders</span>
                </a>
            </li>
            <li class="menu-item">
                <a href="/Farmer-Page/Farmer-earning-page.html" class="menu-link">
                    <span class="menu-icon"><i class="fa-solid fa-wallet"></i></span>
                    <span>Earnings</span>
                </a>
            </li>
            <li class="menu-item">
                <a href="#settings" class="menu-link">
                    <span class="menu-icon"><i class="fa-solid fa-gear"></i></span>
                    <span>Settings</span>
                </a>
            </li>
            <li class="menu-item">
                <a href="#" class="menu-link" onclick="logout()">
                    <span class="menu-icon"><i class="fa-solid fa-right-from-bracket"></i></span>
                    <span>Logout</span>
                </a>
            </li>
        </ul>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Top Header -->
        <div class="top-header">
            <div class="welcome-section">
                <h1>Welcome back, Farmer! ðŸ‘‹</h1>
                <p>Here's what's happening with your farm today</p>
            </div>
            <div class="header-right">
                <button class="notification-btn">
                    <i class="fa-solid fa-bell"></i>
                    <span class="notification-badge"></span>
                </button>
                <div class="profile-section">
                    <div class="profile-avatar">F</div>
                    <div class="profile-info">
                        <div class="profile-name">Farm Name</div>
                        <div class="profile-role">Seller</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content Section -->
        <section class="content-section">
            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-info">
                            <h3>Total Products</h3>
                            <div class="stat-value" id="stat-products">0</div>
                            <div class="stat-change">â†‘ 4 new this week</div>
                        </div>
                        <div class="stat-icon"><i class="fa-solid fa-box"></i></div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-info">
                            <h3>Today's Orders</h3>
                            <div class="stat-value" id="stat-orders">0</div>
                            <div class="stat-change">â†‘ 2 from yesterday</div>
                        </div>
                        <div class="stat-icon"><i class="fa-solid fa-cart-shopping"></i></div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-info">
                            <h3>Total Earnings</h3>
                            <div class="stat-value" id="stat-earnings">â‚¹0</div>
                            <div class="stat-change">â†‘ 15% this month</div>
                        </div>
                        <div class="stat-icon"><i class="fa-solid fa-indian-rupee-sign"></i></div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-info">
                            <h3>Pending Orders</h3>
                            <div class="stat-value">3</div>
                            <div class="stat-change">Need attention</div>
                        </div>
                        <div class="stat-icon"><i class="fa-solid fa-triangle-exclamation"></i></div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Grid -->
            <div class="dashboard-grid">
                <!-- Recent Orders -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h2 class="card-title">Recent Orders</h2>
                        <a href="#" class="view-all-link">View All â†’</a>
                    </div>

                    <div class="orders-list">
                        <p>Loading orders...</p>
                    </div>
                </div>

                <!-- Alerts -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h2 class="card-title">Alerts</h2>
                    </div>

                    <div class="alerts-list">
                        <div class="alert-box alert-warning">
                            <div class="alert-header">
                                <i class="fa-solid fa-triangle-exclamation"></i> Low Stock Alert
                            </div>
                            <div class="alert-content">
                                <div class="stock-item">
                                    <span class="stock-name">Organic Tomatoes</span>
                                    <span class="stock-value">5 kg</span>
                                </div>
                                <div class="stock-item">
                                    <span class="stock-name">Fresh Carrots</span>
                                    <span class="stock-value">3 kg</span>
                                </div>
                                <div class="stock-item">
                                    <span class="stock-name">Green Chillies</span>
                                    <span class="stock-value">2 kg</span>
                                </div>
                            </div>
                        </div>

                        <div class="alert-box alert-info">
                            <div class="alert-header">
                                <i class="fa-solid fa-cart-shopping"></i> 3 new orders
                            </div>
                            <div class="alert-content">
                                You have 3 new orders waiting to be processed
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script type="module">
        import apiRequest from "/js/api.js";
        import { getCurrentUser, logout } from "/js/auth.js";
        import { showToast } from "/js/notifications.js";

        window.logout = logout;

        async function loadDashboard() {
            const user = getCurrentUser();
            if (!user || user.role !== 'farmer' || !user.farmer_id) {
                showToast('Access denied. Only approved farmers can access this page.', 'error');
                window.location.href = '/pages/login.html';
                return;
            }

            // Update profile name
            document.querySelector('.profile-name').innerText = user.name;

            const farmerId = user.farmer_id;
            try {
                // 1. Load Stats
                const products = await apiRequest(`/products/farmer/${farmerId}`, 'GET');
                document.getElementById('stat-products').innerText = products.length;

                const orders = await apiRequest(`/orders/farmer/${farmerId}`, 'GET');
                document.getElementById('stat-orders').innerText = orders.length;

                const earnings = orders.reduce((sum, o) => sum + (o.total_amount || 0), 0);
                document.getElementById('stat-earnings').innerText = `â‚¹${earnings.toFixed(2)}`;

                // 2. Load Recent Orders
                const ordersList = document.querySelector('.orders-list');
                const recentOrders = orders.slice(0, 5);

                if (recentOrders.length === 0) {
                    ordersList.innerHTML = '<p style="padding: 20px;">No orders yet.</p>';
                } else {
                    ordersList.innerHTML = recentOrders.map(o => `
                        <div class="order-item">
                            <div class="order-header">
                                <span class="order-id">#ORD-${o.id}</span>
                                <span class="order-amount">â‚¹${o.total_amount}</span>
                            </div>
                            <div class="order-customer">User ID: ${o.user_id}</div>
                             <span class="order-status status-${o.status}">${o.status}</span>
                        </div>
                    `).join('');
                }

            } catch (err) {
                console.error("Dashboard error:", err);
            }
        }

        loadDashboard();

        window.toggleSidebar = () => {
            document.getElementById('sidebar').classList.toggle('active');
        };
    </script>
</body>

</html>